env:
  - SENTRY_RELEASE=$TRAVIS_TAG

matrix:
  include:
    - os: linux
      dist: bionic
      language: node_js
      node_js: lts/*
      services:
        - xvfb
    - os: osx
      osx_image: xcode10
      language: node_js
      node_js: lts/*
      if: tag IS present
    # - os: windows
    #   language: node_js
    #   node_js: lts/*
    #   if: tag IS present

branches:
  except:
    - hotfix/*
    - feature/*
    - release/*

cache: false

before_install:
  - if [[ $TRAVIS_OS_NAME = linux && ! -z $TRAVIS_TAG ]]; then snap install snapcraft --classic; fi

install:
  - if [ $TRAVIS_OS_NAME = osx ]; then yarn install; fi
  - if [ $TRAVIS_OS_NAME = linux ]; then yarn install; fi
  - if [ $TRAVIS_OS_NAME = windows ]; then npm install; fi

script:
  - yarn lint
  - if [ $TRAVIS_OS_NAME = osx ]; then yarn test; fi
  - if [ $TRAVIS_OS_NAME = linux ]; then xvfb-run -a yarn test; fi
  - yarn build
after_success:
  - if [ $TRAVIS_OS_NAME = linux ]; then xvfb-run -a yarn test:coverage; fi
  - if [ $TRAVIS_OS_NAME = linux ]; then cat ./coverage/lcov.info | yarn coveralls; fi

before_deploy:
  - yarn electron-pack
  - yarn sentry-cli releases new $SENTRY_RELEASE
  - yarn sentry-cli releases files $SENTRY_RELEASE upload-sourcemaps --rewrite ./build
  - yarn sentry-cli releases finalize $SENTRY_RELEASE
  - ls ./
  - ls ./dist

deploy:
  provider: releases
  skip_cleanup: true
  api_key: $GITHUB_REPO_TOKEN
  name: Release $TRAVIS_TAG
  draft: true
  file_glob: true
  file:
    - ./dist/*.zip
    - ./dist/*.dmg
    - ./dist/*.AppImage
    - ./dist/*.snap
    - ./dist/*.yml
    - ./dist/*.exe
  on:
    tags: true
